<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kataribe WebRTC P2P Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connecting { background-color: #fff3cd; }
        .status.connected { background-color: #d4edda; }
        .status.disconnected { background-color: #f8d7da; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        input[type="text"] {
            width: 200px;
            padding: 8px;
            margin: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Kataribe WebRTC P2P Demo</h1>
    
    <div class="container">
        <h3>Connection Status</h3>
        <div id="status" class="status disconnected">Disconnected</div>
        <button id="connectBtn">Connect as Initiator</button>
        <button id="waitBtn">Wait for Connection</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div class="container">
        <h3>RPC Test</h3>
        <div>
            <input type="text" id="numA" placeholder="Number A" value="5">
            <input type="text" id="numB" placeholder="Number B" value="3">
            <button id="addBtn" disabled>Call Add RPC</button>
        </div>
        <div>
            <input type="text" id="userId" placeholder="User ID" value="123">
            <button id="getUserBtn" disabled>Call GetUser RPC</button>
        </div>
        <div>Result: <span id="result">-</span></div>
    </div>

    <div class="container">
        <h3>Events Test</h3>
        <button id="emitLogBtn" disabled>Emit Server Log Event</button>
        <button id="emitUserBtn" disabled>Emit User Joined Event</button>
    </div>

    <div class="container">
        <h3>Debug Log</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script src="../dist/kataribe.umd.js"></script>
    <script>
        // Contract definition (same as contract.ts)
        function isNumber(x) {
            return typeof x === "number" && !isNaN(x);
        }

        const contract = Kataribe.defineContract({
            rpcToServer: {
                add: Kataribe.rpc({
                    validateReq(raw) {
                        if (typeof raw !== "object" || raw === null)
                            throw new Error("invalid add req");
                        const r = raw;
                        if (!isNumber(r.a) || !isNumber(r.b))
                            throw new Error("a/b must be number");
                        return { a: r.a, b: r.b };
                    },
                    validateRes(raw) {
                        if (typeof raw !== "object" || raw === null)
                            throw new Error("invalid add res");
                        const r = raw;
                        if (!isNumber(r.sum)) throw new Error("sum must be number");
                        return { sum: r.sum };
                    },
                }),
                getUser: Kataribe.rpc(),
            },
            rpcToClient: {
                notifyClient: Kataribe.rpc(),
            },
            events: {
                serverLog: Kataribe.event(),
                userJoined: Kataribe.event(),
            },
        });

        let client = null;

        // UI Elements
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const waitBtn = document.getElementById('waitBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const addBtn = document.getElementById('addBtn');
        const getUserBtn = document.getElementById('getUserBtn');
        const emitLogBtn = document.getElementById('emitLogBtn');
        const emitUserBtn = document.getElementById('emitUserBtn');
        const resultEl = document.getElementById('result');
        const logEl = document.getElementById('log');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function updateStatus(status, text) {
            statusEl.className = `status ${status}`;
            statusEl.textContent = text;
        }

        function setButtonsEnabled(connected) {
            connectBtn.disabled = connected;
            waitBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            addBtn.disabled = !connected;
            getUserBtn.disabled = !connected;
            emitLogBtn.disabled = !connected;
            emitUserBtn.disabled = !connected;
        }

        async function connectAsInitiator() {
            try {
                updateStatus('connecting', 'Connecting as initiator...');
                log('Attempting to connect as initiator...');
                
                client = await Kataribe.createWebRTCClient({
                    contract,
                    signalingUrl: 'ws://localhost:3001',
                    isInitiator: true,
                    handlersForServerCalls: {
                        notifyClient: async ({ message }) => {
                            log(`Received notification: ${message}`);
                            return { received: true };
                        }
                    }
                });

                setupClient();
                updateStatus('connected', 'Connected as initiator');
                setButtonsEnabled(true);
                log('Successfully connected as initiator');
            } catch (error) {
                log(`Failed to connect as initiator: ${error.message}`);
                updateStatus('disconnected', 'Connection failed');
                setButtonsEnabled(false);
            }
        }

        async function waitForConnection() {
            try {
                updateStatus('connecting', 'Waiting for connection...');
                log('Waiting for peer connection...');
                
                client = await Kataribe.createWebRTCClient({
                    contract,
                    signalingUrl: 'ws://localhost:3001',
                    isInitiator: false,
                    handlersForServerCalls: {
                        notifyClient: async ({ message }) => {
                            log(`Received notification: ${message}`);
                            return { received: true };
                        }
                    }
                });

                setupClient();
                updateStatus('connected', 'Connected as responder');
                setButtonsEnabled(true);
                log('Successfully connected as responder');
            } catch (error) {
                log(`Failed to wait for connection: ${error.message}`);
                updateStatus('disconnected', 'Connection failed');
                setButtonsEnabled(false);
            }
        }

        function setupClient() {
            // Set up event handlers
            client.onEvent('serverLog', ({ level, message }) => {
                log(`[Event] Server Log [${level}]: ${message}`);
            });

            client.onEvent('userJoined', ({ id, name }) => {
                log(`[Event] User Joined: ${name} (${id})`);
            });
        }

        function disconnect() {
            if (client) {
                client.close();
                client = null;
            }
            updateStatus('disconnected', 'Disconnected');
            setButtonsEnabled(false);
            log('Disconnected');
        }

        async function callAdd() {
            if (!client) return;
            
            try {
                const a = parseFloat(document.getElementById('numA').value);
                const b = parseFloat(document.getElementById('numB').value);
                
                log(`Calling add RPC with a=${a}, b=${b}`);
                const result = await client.rpc.add({ a, b });
                resultEl.textContent = `Sum: ${result.sum}`;
                log(`Add RPC result: ${result.sum}`);
            } catch (error) {
                log(`Add RPC failed: ${error.message}`);
                resultEl.textContent = `Error: ${error.message}`;
            }
        }

        async function callGetUser() {
            if (!client) return;
            
            try {
                const id = document.getElementById('userId').value;
                
                log(`Calling getUser RPC with id=${id}`);
                const result = await client.rpc.getUser({ id });
                resultEl.textContent = `User: ${result.name} (${result.id})`;
                log(`GetUser RPC result: ${result.name} (${result.id})`);
            } catch (error) {
                log(`GetUser RPC failed: ${error.message}`);
                resultEl.textContent = `Error: ${error.message}`;
            }
        }

        function emitServerLog() {
            if (!client) return;
            
            const levels = ['info', 'warn', 'error'];
            const level = levels[Math.floor(Math.random() * levels.length)];
            const message = `Test log message at ${new Date().toLocaleTimeString()}`;
            
            client.emit.serverLog({ level, message });
            log(`Emitted serverLog event: [${level}] ${message}`);
        }

        function emitUserJoined() {
            if (!client) return;
            
            const id = Math.random().toString(36).substring(2, 8);
            const name = `User${id}`;
            
            client.emit.userJoined({ id, name });
            log(`Emitted userJoined event: ${name} (${id})`);
        }

        function clearLog() {
            logEl.innerHTML = '';
        }

        // Event listeners
        connectBtn.addEventListener('click', connectAsInitiator);
        waitBtn.addEventListener('click', waitForConnection);
        disconnectBtn.addEventListener('click', disconnect);
        addBtn.addEventListener('click', callAdd);
        getUserBtn.addEventListener('click', callGetUser);
        emitLogBtn.addEventListener('click', emitServerLog);
        emitUserBtn.addEventListener('click', emitUserJoined);

        // Initialize
        setButtonsEnabled(false);
        log('WebRTC Demo initialized. Start the signaling server first!');
    </script>
</body>
</html>